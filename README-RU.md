# Демо Telegram Mini App

В этом репозитории представлен пример разработки мини-приложения "Магазин мини-приложений" для платформы Telegram. Живая тестовая версия приложения доступна по [этой ссылке](https://t.me/tg_app_store_bot). 

Основные функции:

* просмотр приложений по категориям
* добавление приложений в избранное
* выставление оценки
* запуск приложения прямо из магазина

Вы можете использовать этот репозиторий в качестве отправной точки при разработке своего собственного мини-приложения.

# Структура репозитория

Репозиторий состоит из 2-х основных частей: webapp - frontend часть приложения и backend - backend часть приложения.

## Webapp

webapp представляет собой легковесный UI, отображаемый в боте. Исходный код находится в папке webapp. По своей сути это минималистичный вэб-проект (HTML, CSS, JS) без лишних зависимостей, реализующий концепцию single web page application - все необходимые скрипты и стили для генерации страниц загружаются один раз, а сами страницы строятся на основании небольших порций данных, полученных от backend. Такой подход позволяет минимизировать время, необходимое для генерации новой страницы, что оснобенно важно при реализации плавных и быстрых приложений.

Основная и единственная HTML страница - index.html, представляет собой оболочку, которая подключает необходимые css и js зависимости и содержит единственный элемент frame-root в который динамически помещаются отображаемые страницы. Рассмторим детальнее структуру каталога webapp.

### index.html

Главный файл Telegram Mini App.

### config.js

Файл-конфигуратор, определяет окружение, в котором будет работать на fronend. В данный момент определено одно свойство serverUrl - адрес сервера, куда будут отправляться запросы для получения данных.

### data-repository.js

Данный файл содержит модели данных, используемые в приложении и набор методов для взаимодействия с сервером.

### ui.js

Набор методов-генераторов элементов интерфеса вэб страниц.

### utils.js

Набор обёрток для манипуляции DOM деревом страницы.

### navigation.js

Легковесный фрэймворк для реализации концепции single web page application. Содержит основные методы по замене, добавлению и удалению страниц-экранов в определйнный в index.html фрэйм. Одной из полезных функция является автоматическое обновление свойства window.Telegram.WebApp.BackButton.isVisible при изменении стэка страниц. При работе над своей версий приложения, выполненной на базе текущего проекта, для минимизации ошибок навигации рекомендуется использовать методы из этого файла.

### *-app.js

Страницы приложения. Каждый такой файл содержит метод display* который вызывает при необходимости открыть страницу.

### main.js

Основная точка входа, открывает первую страницу после полной загрузки документа.

### webapp/css

Основной файл style.css - таблица стилей, используемых в приложении. В папке находятся 2 вспомогательных файла: css-class-name-generator.sh и css-class-names.js. Т.к. наше приложение генерирует весь контент на месте, в js файлах, удобно иметь доступ к названиям стилей без необходимости каждый раз копировать их название. Для решения этой задачи можно каждый раз после добавления или изменения класса в файле style.css запускать скрипт css-class-name-generator.sh, который в свою очередь генерирует файл css-class-names.js - js файл с константами названий классов из style.css. Такой подход позволяет использовать автодополнение во время вёрстки блоков в js файлах.

### webapp/stub

Данный каталог содержит единственный файл mock-data-repository.js - файл с переопределёнными методами взаимодействия с bacend (из файла data-repository.js) и некоторый набор мок данных. Для его подключения достаточно раскомментировать соответствующую строку в index.html. Данный файл будет перенаправлять все запросы к серверу в обработчики, определенные в mock-data-repository.js, таким образом запросы не будут уходить на реальный сервер.

## Backend

Backend часть обрабатывает пользовательские запросы. Исходный код находится в папке backend, используется сервер ktor.

### resources

Одержит необходимые для работы ktor сервера настройки

# Окружение и инструменты

Рекомендуемое окружение для локального запуска

* *nix система
* Java 17 и выше

Рекомендуемые IDE для работы

* Visual Studio Code для работы с frontend частью
* Intellij idea community edition для работы с backend частью

Сервис для развертывания backend (опционально)

* Heroku или другая аналогичная платформа для развертывания Java приложения

# Использование

## Подготовка проекта и окружения

Для начала подготовим окружение.

### Форк репозитория

Чтобы была возможность вносить свои изменения и получать обновления создайте форк текущего репозитория.

### Telegram бот

Создайте свой бот в Telegram. Если вы никогда до этого не имели дело с ботами в Telegram, воспользуйтесь одной из инструкцией, например, [этой из официальной документации](https://core.telegram.org/bots/tutorial).

На данном этапе нам достаточно дойти до получения токена, сам код для бота писать не нужно, однако вы всегда можете добавить некоторую функциональность в классический Telegram бот позже.

### Проверка доступности index.html

В отличии от классического Telegram бота, которому важно наличие backend, для работы Telegram Mini App в минимальном варианте достаточно только наличия вэб страницы. Самым простым и бесплатным способом хостинга статических html страниц является сам GitHub. Для этого мы будем использовать [GitHub Pages](https://pages.github.com) разместив в нем содержимое нашего каталога webapp. GitHub Pages разрешает размещать такой контент в 2-х местах (на момент написания инструкции): корневая дирректория /(root) или дирректория /docs. Для удобства разделения различных частей проекта наш контент размещается в дирректории /webapp, чтобы он стал доступен для отображения в GitHub Pages в репозитории используется плагин [GitHub Pages Overwriter](https://github.com/marketplace/actions/github-pages-overwriter). Убедитесь, что он работает во вкладке Actions вашего репозитория. 

Если Action отрабатывает с ошибкой, убедитесь, что для Actions включен режим Read and write permissions. Проверить это можно в репозитории, Settings -> Actions (Code and automation) -> General -> Workflow permissions. Должно быть выбрано Read and write permissions.

Если публикация прошла успешно, по адресу http://username.github.io/repository (в текущем репозитории это http://landarskiy.github.io/tg-app-store) будет доступна html страница и при её открытии отобразится контент нашего магазина.

Если по каким-либо причинам после успешного выполнения Action содержимое папки webapp не стало доступно по ссылке GitHub Pages, сверьтесь с инструкцией плагина GitHub Pages Overwriter. Обратите внимание, правильно ли вы настроили Pages в вашем репозитории, запускается ли Action при пуше изменений, существует ли ветка, на которую настроен плагин. В крайнем случае рассмотрите перемещение сожержимого из дирректории /webapp в дирректорию /docs как того требует GitHub Pages, в этом случае вам не понадоиться пользоваться указанным выше плагином.

### Подключение Mini App к боту

Следуя [официальной инструкции](https://core.telegram.org/bots/webapps#launching-mini-apps-from-the-menu-button) добавьте в ранее созданный бот путь к GitHub Pages страницы репозитория.

Если всё выполнено верно, можно зайти в ваш бот и открыть в нём приложение магазина через кнопку меню.


## Режимы запуска

С приложением можно работать в 3-х условных режимах: 

* HTML-only песочница, без backend
* песочница с локальным backend-ом
* production версия

### HTML-only песочница

Данный режим работы с проектом предназначем в первую очередь для вёрстки приложения и тестирования корректности отработки базывах сценариев.